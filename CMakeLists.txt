cmake_minimum_required(VERSION 2.8)
project (Functors)

# Find and import OpenCL.
option(FNC_ENABLE_OPENCL
  "Enable/disable OpenCL (required for any real execution)."
  OFF)

if (FNC_ENABLE_OPENCL)
  set (CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/FindOpenCL")
  find_package(OpenCL REQUIRED)
  include_directories(${OPENCL_INCLUDE_DIRS})
  if (NOT OPENCL_HAS_CPP_BINDINGS)
    include_directories("${CMAKE_SOURCE_DIR}/OpenCLCpp")
  endif()
endif()

FIND_PATH(GOOGLE_CTEMPLATE_INCLUDE_DIR google/template.h /usr/include /usr/local/include)
FIND_LIBRARY(GOOGLE_CTEMPLATE_THREAD_LIB ctemplate /usr/lib /usr/loca/lib)


# List of Boost features used:
# * Smart Ptr
# * xpressive
# * program options
find_package(Boost REQUIRED
  COMPONENTS program_options # program_options is only needed for the testing
                             # executables
  )

include_directories(${Boost_INCLUDE_DIRS}
  ${CMAKE_CURRENT_BINARY_DIR}
  ${GOOGLE_CTEMPLATE_INCLUDE_DIR}
  )

add_executable(daxGenerateHeaderFromFile
  daxGenerateHeaderFromFile.cxx)
target_link_libraries(daxGenerateHeaderFromFile
  ${Boost_LIBRARIES})

add_executable(openclBuilder
  openclBuilder.cxx)
target_link_libraries(openclBuilder
  ${Boost_LIBRARIES})
if(FNC_ENABLE_OPENCL)
  target_link_libraries(openclBuilder ${OPENCL_LIBRARIES})
endif()


configure_file(${CMAKE_CURRENT_SOURCE_DIR}/daxOptions.h.in
  ${CMAKE_CURRENT_BINARY_DIR}/daxOptions.h
  @ONLY)

function (encode_to_headers out_variable)
  set (all_headers)
  foreach(file ${ARGN})
    set(src ${CMAKE_CURRENT_SOURCE_DIR}/${file})
    get_filename_component(filename ${file} NAME)
    set(res ${CMAKE_CURRENT_BINARY_DIR}/${filename}.h)
    list(APPEND all_headers ${res})
    add_custom_command(
      OUTPUT ${res}
      DEPENDS ${src} daxGenerateHeaderFromFile
      COMMAND daxGenerateHeaderFromFile
      ARGS  --input-file ${src} --output-file ${res}
      )
  endforeach()
  set (${out_variable} ${all_headers} PARENT_SCOPE)
endfunction()

set (functor_modules
)

set (core_kernels
  Functors/Elevation.cl
  Functors/CellAverage.cl
  Functors/CellGradient.cl
  Functors/CellGradient2.cl
  Functors/CellDataToPointData.cl
  Resources/Kernel.tmpl
  Resources/KernelGetArray.tmpl
  Resources/dAPI.cl
)

set (generated_headers_core)
encode_to_headers(generated_headers_core
  ${core_kernels}
  )
set (generated_headers)
encode_to_headers(generated_headers
  ${functor_modules}
  )
#message ("Headers: ${generated_headers}")

# daxFramework is the core library
add_library(daxFramework SHARED
  daxArray.cxx
  daxArray.h
  daxAttributeKeyBase.cxx
  daxAttributeKeyBase.h
  daxAttributeKey.h
  daxField.cxx
  daxField.h
  daxModule.cxx
  daxModule.h
  daxObject.cxx
  daxObject.h
  daxPort.cxx
  daxPort.h

  daxCellAverageModule.cxx
  daxCellAverageModule.h
  daxCellDataToPointDataModule.cxx
  daxCellDataToPointDataModule.h
  daxCellGradientModule2.cxx
  daxCellGradientModule2.h
  daxCellGradientModule.cxx
  daxCellGradientModule.h
  daxElevationModule.cxx
  daxElevationModule.h
  daxExecutive2.cxx

# daxAutoGeneratedModule.cxx
# daxAutoGeneratedModule.h
# daxDataObject.cxx
# daxDataObject.h
# daxExecutive.cxx
# daxExecutive.h
# daxImageData.cxx
# daxImageData.h
  ${generated_headers_core}
)

target_link_libraries(daxFramework
  ${Boost_LIBRARIES}
  ${GOOGLE_CTEMPLATE_THREAD_LIB}
  )

if(FNC_ENABLE_OPENCL)
  target_link_libraries(daxFramework ${OPENCL_LIBRARIES})
endif()

foreach (file ${generated_headers_core})
  set_source_files_properties(daxObject.h
    PROPERTIES OBJECT_DEPENDS ${file})
endforeach()

# Add executables, mostly testing samples
add_executable(daxTest
  daxTest.cxx
  ${generated_headers}
  )

foreach (file ${generated_headers})
  set_source_files_properties(daxTest.cxx
    PROPERTIES OBJECT_DEPENDS ${file})
endforeach()

target_link_libraries(daxTest
  daxFramework
  )
